<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Observe Mode — ReserveGrid OS</title>
  <meta name="description" content="Live gateway monitoring dashboard. Share events, verdict analytics, reason code breakdown, and policy state for your SV2 deployment.">
  <meta name="theme-color" content="#080e1a">

  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/brand/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/brand/favicon-16.png">
  <link rel="apple-touch-icon" href="/assets/brand/apple-touch-icon.png">

  <meta property="og:title" content="Observe Mode — ReserveGrid OS">
  <meta property="og:description" content="Read-only template verification dashboard for Bitcoin mining pools.">
  <meta property="og:url" content="https://veldra.org/observe/">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://veldra.org/assets/brand/veldra-mark.png">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="stylesheet" href="/assets/style.css?v=10">
  <script src="/assets/script.js?v=10" defer></script>

  <style>
    /* ── Observe-specific styles ────────────────── */

    .demo-banner {
      background: rgba(220,120,20,.07);
      border: 1px solid rgba(220,120,20,.18);
      padding: 12px 20px;
      border-radius: var(--r-md);
      color: #7a4a10;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 32px;
    }
    .demo-banner strong { color: #8b4513; }
    .demo-banner.hidden { display: none; }

    .connection-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .connection-bar label {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink-muted);
      white-space: nowrap;
    }
    .connection-bar input {
      flex: 1;
      min-width: 200px;
      padding: 6px 12px;
      border: 1px solid var(--border-md);
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--ink);
      background: var(--bg);
    }
    .connection-bar input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0,104,181,.1);
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.live { background: var(--green); box-shadow: 0 0 6px rgba(118,185,0,.5); }
    .status-dot.demo { background: #d4880f; }
    .status-dot.connecting { background: #888; animation: pulse-dot 1s ease-in-out infinite; }
    .status-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--ink-muted);
      white-space: nowrap;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: .3; }
    }

    /* ── Stats panel ──────────────────────────── */
    .observe-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      overflow: hidden;
      margin-bottom: 40px;
    }
    .observe-stat {
      background: var(--panel);
      padding: 24px;
      text-align: center;
    }
    .observe-stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--blue);
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
    }
    .observe-stat-value.green { color: var(--green); }
    .observe-stat-value.red { color: #dc503c; }
    .observe-stat-label {
      font-size: 13px;
      color: var(--ink-muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .observe-stat-sub {
      font-size: 12px;
      color: var(--ink-subtle);
      margin-top: 2px;
    }
    .stat-live .observe-stat-value {
      animation: pulse-val 2s ease-in-out infinite;
    }
    @keyframes pulse-val {
      0%, 100% { opacity: 1; }
      50% { opacity: .7; }
    }

    /* ── Two-column layout ────────────────────── */
    .observe-columns {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 24px;
      margin-bottom: 40px;
    }

    /* ── Verdict stream ───────────────────────── */
    .verdict-stream {
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      overflow: hidden;
      background: var(--panel);
    }
    .verdict-stream-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .verdict-stream-header small {
      font-weight: 400;
      color: var(--ink-subtle);
      font-size: 12px;
    }
    .verdict-stream-body {
      max-height: 460px;
      overflow-y: auto;
    }
    .verdict-row {
      display: grid;
      grid-template-columns: 80px 1fr 72px 56px 90px;
      gap: 8px;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      align-items: center;
      font-size: 13px;
      transition: background .12s;
      border-left: 3px solid transparent;
    }
    .verdict-row:last-child { border-bottom: none; }
    .verdict-row:hover { background: rgba(0,104,181,.02); }
    .verdict-row.accepted { border-left-color: var(--green); }
    .verdict-row.rejected { border-left-color: #dc503c; }
    .verdict-ts {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink-subtle);
    }
    .verdict-id {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .verdict-height {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink-muted);
      text-align: right;
    }
    .verdict-txcount {
      font-size: 12px;
      color: var(--ink-muted);
      text-align: right;
    }
    .verdict-badge {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .03em;
      padding: 2px 8px;
      border-radius: 4px;
      text-align: center;
    }
    .verdict-badge.ok {
      color: #2d6a00;
      background: rgba(118,185,0,.1);
    }
    .verdict-badge.fail {
      color: #9c2b1a;
      background: rgba(220,80,60,.08);
    }
    .verdict-reason {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-subtle);
      grid-column: 1 / -1;
      padding-top: 4px;
    }

    /* ── Reason chart ─────────────────────────── */
    .reason-panel {
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: var(--panel);
      overflow: hidden;
    }
    .reason-panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
    }
    .reason-chart {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .reason-item {
      display: grid;
      grid-template-columns: 180px 1fr 40px;
      gap: 10px;
      align-items: center;
    }
    .reason-label {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .bar-track {
      height: 20px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #dc503c, #b83c2e);
      border-radius: 4px;
      min-width: 4px;
      transition: width .4s ease;
    }
    .reason-count {
      font-size: 13px;
      font-weight: 600;
      color: var(--ink);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .reason-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--ink-subtle);
      font-size: 14px;
    }

    /* ── Fee tiers ────────────────────────────── */
    .tier-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }
    .tier-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 24px;
      text-align: center;
      transition: border-color .15s, box-shadow .15s;
    }
    .tier-card.active {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0,104,181,.08);
    }
    .tier-name {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--ink-muted);
      margin-bottom: 8px;
    }
    .tier-count {
      font-size: 28px;
      font-weight: 700;
      color: var(--ink);
      font-variant-numeric: tabular-nums;
    }
    .tier-threshold {
      font-size: 12px;
      color: var(--ink-subtle);
      margin-top: 4px;
      font-family: var(--mono);
    }

    /* ── Policy panel ─────────────────────────── */
    .policy-toggle {
      cursor: pointer;
      user-select: none;
    }
    .policy-toggle summary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      list-style: none;
    }
    .policy-toggle summary::-webkit-details-marker { display: none; }
    .policy-toggle summary::before {
      content: '\25B6';
      font-size: 10px;
      color: var(--ink-muted);
      transition: transform .15s;
    }
    .policy-toggle[open] summary::before { transform: rotate(90deg); }

    /* ── Architecture diagram ─────────────────── */
    .arch-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      padding: 40px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    .arch-box {
      text-align: center;
      padding: 20px 24px;
      border: 1px solid var(--border-md);
      border-radius: var(--r-md);
      background: var(--bg);
      min-width: 140px;
    }
    .arch-box-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .arch-box-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
    }
    .arch-box-desc {
      font-size: 12px;
      color: var(--ink-muted);
      margin-top: 4px;
    }
    .arch-arrow {
      font-size: 20px;
      color: var(--ink-subtle);
      padding: 0 12px;
      flex-shrink: 0;
    }

    /* ── Reason catalog table ─────────────────── */
    .catalog-table {
      width: 100%;
      border-collapse: collapse;
    }
    .catalog-table th {
      text-align: left;
      padding: 10px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--ink-muted);
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }
    .catalog-table td {
      padding: 12px 16px;
      font-size: 13px;
      color: var(--ink);
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .catalog-table td:first-child {
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
      color: var(--blue-dark);
    }
    .catalog-table tr:last-child td { border-bottom: none; }
    .catalog-table tr:hover td { background: rgba(0,104,181,.02); }
    .catalog-category {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .04em;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .cat-protocol { color: var(--blue); background: rgba(0,104,181,.06); }
    .cat-policy { color: #7a4a10; background: rgba(220,160,40,.08); }
    .cat-fee { color: #2d6a00; background: rgba(118,185,0,.08); }
    .cat-system { color: #9c2b1a; background: rgba(220,80,60,.06); }

    /* ── Auth gate ────────────────────────────── */
    .auth-gate {
      max-width: 440px;
      margin: 0 auto;
      padding: 48px 0 80px;
    }
    .auth-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 36px 32px;
      box-shadow: var(--shadow-md);
    }
    .auth-card h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 4px;
    }
    .auth-card p.sub {
      font-size: 14px;
      color: var(--ink-muted);
      margin-bottom: 24px;
    }
    .auth-field {
      margin-bottom: 16px;
    }
    .auth-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--ink-muted);
      margin-bottom: 6px;
    }
    .auth-field input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border-md);
      border-radius: 8px;
      font-size: 14px;
      font-family: var(--sans);
      color: var(--ink);
      background: var(--bg);
      box-sizing: border-box;
    }
    .auth-field input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0,104,181,.1);
    }
    .auth-submit {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, box-shadow .15s;
      margin-top: 8px;
      font-family: var(--sans);
    }
    .auth-submit.primary {
      background: var(--blue);
      color: #fff;
    }
    .auth-submit.primary:hover {
      background: var(--blue-light);
      box-shadow: var(--shadow-sm);
    }
    .auth-submit:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    .auth-toggle {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: var(--ink-muted);
    }
    .auth-toggle a {
      color: var(--blue);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }
    .auth-toggle a:hover { text-decoration: underline; }
    .auth-msg {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }
    .auth-msg.error {
      display: block;
      background: rgba(220,80,60,.06);
      border: 1px solid rgba(220,80,60,.14);
      color: #9c2b1a;
    }
    .auth-msg.success {
      display: block;
      background: rgba(118,185,0,.06);
      border: 1px solid rgba(118,185,0,.14);
      color: #2d6a00;
    }
    .auth-user-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      margin-bottom: 16px;
      font-size: 13px;
    }
    .auth-user-bar .user-info {
      color: var(--ink-muted);
    }
    .auth-user-bar .user-info strong {
      color: var(--ink);
    }
    .auth-user-bar .logout-link {
      color: var(--blue);
      cursor: pointer;
      font-weight: 500;
      text-decoration: none;
      font-size: 13px;
      border: none;
      background: none;
      font-family: var(--sans);
    }
    .auth-user-bar .logout-link:hover { text-decoration: underline; }
    .hidden { display: none !important; }

    /* ── Stale overlay ────────────────────────── */
    .stale .observe-stat-value { opacity: .4; }
    .last-updated {
      font-size: 12px;
      color: var(--ink-subtle);
      text-align: right;
      margin-bottom: 8px;
    }

    /* ── Responsive ───────────────────────────── */
    @media (max-width: 1024px) {
      .observe-stats { grid-template-columns: repeat(2, 1fr); }
      .observe-columns { grid-template-columns: 1fr; }
      .tier-grid { grid-template-columns: repeat(3, 1fr); }
      .reason-item { grid-template-columns: 140px 1fr 36px; }
    }
    @media (max-width: 768px) {
      .observe-stats { grid-template-columns: 1fr 1fr; }
      .tier-grid { grid-template-columns: 1fr; }
      .verdict-row { grid-template-columns: 64px 1fr 56px; }
      .verdict-height, .verdict-txcount { display: none; }
      .arch-diagram { flex-direction: column; gap: 8px; }
      .arch-arrow { transform: rotate(90deg); }
      .reason-item { grid-template-columns: 1fr 40px; }
      .reason-label { grid-column: 1 / -1; }
      .connection-bar { flex-direction: column; align-items: stretch; }
      .safety-grid { grid-template-columns: 1fr !important; }
    }

    /* ── Consensus safety panel ──────────────── */
    .safety-section {
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: var(--panel);
      overflow: hidden;
      margin-bottom: 40px;
    }
    .safety-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .safety-header small {
      font-weight: 400;
      color: var(--ink-subtle);
      font-size: 12px;
    }
    .safety-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--border);
    }
    .safety-metric {
      background: var(--panel);
      padding: 20px;
    }
    .safety-metric-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .04em;
      color: var(--ink-muted);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .gauge-track {
      height: 14px;
      background: var(--bg);
      border-radius: 7px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .gauge-fill {
      height: 100%;
      border-radius: 7px;
      min-width: 2px;
      transition: width .4s ease, background .3s;
    }
    .gauge-fill.weight { background: var(--blue); }
    .gauge-fill.weight.critical { background: #dc503c; }
    .gauge-fill.sigops { background: var(--green); }
    .gauge-fill.sigops.critical { background: #dc503c; }
    .gauge-label {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink-muted);
    }
    .safety-value {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 600;
      color: var(--ink);
      margin-top: 4px;
    }
    .safety-value.warn { color: #dc503c; }
    .safety-warnings-bar {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      font-size: 13px;
      color: var(--ink-muted);
    }
    .safety-warnings-bar.active {
      color: #b45309;
      background: rgba(220,160,40,.04);
    }

    /* ── Collapsible reason rows ─────────────── */
    .reason-item.expandable { cursor: pointer; }
    .reason-item.expandable:hover { background: rgba(0,104,181,.02); }
    .reason-chevron {
      font-size: 10px;
      color: var(--ink-muted);
      transition: transform .15s;
      margin-right: 6px;
      display: inline-block;
    }
    .reason-chevron.open { transform: rotate(90deg); }
    .reason-detail-row {
      padding: 6px 20px 6px 32px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-subtle);
      border-bottom: 1px solid var(--border);
    }
    .reason-detail-row:last-child { border-bottom: none; }
    .reason-more {
      padding: 4px 20px 8px 32px;
      font-size: 11px;
      color: var(--ink-subtle);
    }

    /* ── Safety verdict badge ────────────────── */
    .verdict-warning-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #d4880f;
      margin-left: 4px;
      vertical-align: middle;
    }

    /* ── Safety catalog category ─────────────── */
    .cat-safety { color: #7c5cff; background: rgba(124,92,255,.06); }

    /* ── Enforcement mode badge ──────────────── */
    .enforce-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .04em;
      padding: 1px 6px;
      border-radius: 3px;
      margin-left: 6px;
      vertical-align: middle;
    }
    .enforce-badge.enforced {
      color: #9c2b1a;
      background: rgba(220,80,60,.08);
    }
    .enforce-badge.observe {
      color: var(--ink-muted);
      background: var(--bg);
    }

    /* ── Export bar ──────────────────────────── */
    .export-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--ink-muted);
    }
    .export-link {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--blue);
      text-decoration: none;
      font-weight: 500;
    }
    .export-link:hover { text-decoration: underline; }

    /* ── Mempool context ─────────────────────── */
    .mempool-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      margin-bottom: 16px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .mempool-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mempool-stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .03em;
      color: var(--ink-muted);
      font-weight: 600;
    }
    .mempool-stat-value {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--ink);
      font-weight: 600;
    }

    /* ── Mixed content warning ───────────────── */
    .mixed-content-warn {
      font-size: 12px;
      color: #b45309;
      background: rgba(220,160,40,.06);
      border: 1px solid rgba(220,160,40,.14);
      padding: 6px 12px;
      border-radius: 6px;
      margin-top: 8px;
      display: none;
    }

    /* ── Extended stale overlay ──────────────── */
    .stale .verdict-stream { opacity: .5; }
    .stale .reason-panel { opacity: .5; }
    .stale .safety-section { opacity: .5; }
    .stale .tier-card { opacity: .5; }
    .stale .mempool-bar { opacity: .5; }
  </style>
</head>
<body>

  <nav class="topbar">
    <div class="container">
      <div class="nav">
        <a class="brand" href="/" aria-label="Veldra home">
          <img src="/assets/brand/veldra-logo.png" alt="Veldra">
        </a>
        <div class="navlinks">
          <a href="/">Home</a>
          <a href="/product/">Product</a>
          <a href="/docs/">Docs</a>
          <a href="/about/">About</a>
        </div>
        <div class="nav-actions">
          <a href="/observe/" class="btn btn-primary btn-sm">Observe</a>
        </div>
        <button class="nav-toggle" aria-label="Menu" aria-expanded="false">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- ── Hero ──────────────────────────────────── -->
  <section class="hero-light" style="padding: 48px 0 32px;">
    <div class="container">
      <div class="hero-inner fade-up">
        <div class="hero-label">
          <span class="hero-label-dot"></span>
          <span class="section-eyebrow" style="margin-bottom:0;">Observe Mode</span>
        </div>
        <h1 class="hero-title" style="font-size:clamp(28px,4vw,48px);color:var(--ink);">
          Gateway monitoring <span class="accent">dashboard</span>
        </h1>
        <p class="hero-sub" style="color:var(--ink-muted);max-width:560px;margin:12px 0 0;">
          Live share events, gateway metrics, reason code analytics, and policy state.
          Real-time insights into your SV2 deployment performance and health.
        </p>
      </div>
    </div>
  </section>

  <!-- ── Auth gate (shown when not authenticated) ── -->
  <div id="auth-gate" class="auth-gate">
    <div class="container">
      <div class="auth-card fade-up">

        <!-- Login form (default view) -->
        <div id="auth-login-form">
          <h2>Sign in to Observe Mode</h2>
          <p class="sub">Access live template verdicts and rejection analytics.</p>
          <div id="login-msg" class="auth-msg"></div>
          <div class="auth-field">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" placeholder="you@example.com" autocomplete="email">
          </div>
          <div class="auth-field">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" placeholder="Your password" autocomplete="current-password">
          </div>
          <button class="auth-submit primary" id="login-btn">Sign in</button>
          <div class="auth-toggle">
            Don't have access? <a id="show-register">Request access</a>
          </div>
        </div>

        <!-- Register form (toggled) -->
        <div id="auth-register-form" class="hidden">
          <h2>Request Observe Access</h2>
          <p class="sub">Submit your info for admin review. You'll receive an email when approved.</p>
          <div id="register-msg" class="auth-msg"></div>
          <div class="auth-field">
            <label for="reg-name">Full name</label>
            <input type="text" id="reg-name" placeholder="Jane Smith" autocomplete="name">
          </div>
          <div class="auth-field">
            <label for="reg-email">Email</label>
            <input type="email" id="reg-email" placeholder="you@example.com" autocomplete="email">
          </div>
          <div class="auth-field">
            <label for="reg-org">Organization</label>
            <input type="text" id="reg-org" placeholder="MIT, a16z, Braiins, etc.">
          </div>
          <div class="auth-field">
            <label for="reg-password">Password</label>
            <input type="password" id="reg-password" placeholder="Minimum 8 characters" autocomplete="new-password">
          </div>
          <button class="auth-submit primary" id="register-btn">Request access</button>
          <div class="auth-toggle">
            Already have access? <a id="show-login">Sign in</a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ── Dashboard (shown when authenticated) ────── -->
  <div id="dashboard-content" class="hidden">

  <!-- ── Connection bar ────────────────────────── -->
  <section style="padding: 0 0 8px;">
    <div class="container">
      <div class="connection-bar fade-up" style="animation-delay:.1s;">
        <label for="api-url">API Endpoint</label>
        <input type="text" id="api-url" placeholder="http://localhost:8080" spellcheck="false" autocomplete="off">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="status-dot connecting" id="status-dot"></span>
          <span class="status-label" id="status-label">Connecting...</span>
        </div>
      </div>

      <div class="auth-user-bar" id="user-bar">
        <span class="user-info">Signed in as <strong id="user-display-name"></strong> (<span id="user-display-org"></span>)</span>
        <button class="logout-link" id="logout-btn">Sign out</button>
      </div>

      <div class="mixed-content-warn" id="mixed-content-warn">
        The API endpoint uses http:// but this page is served over https://. Browsers block mixed content requests. Use an https:// endpoint or access this page over http:// for local testing.
      </div>

      <div class="demo-banner hidden" id="demo-banner">
        <strong>DEMO MODE</strong>
        <span>No live backend detected. Showing example data to illustrate the dashboard.</span>
      </div>
    </div>
  </section>

  <!-- ── Mempool context ──────────────────────── -->
  <section style="padding: 0 0 4px;">
    <div class="container">
      <div class="mempool-bar fade-up" id="mempool-bar" style="animation-delay:.12s;display:none;">
        <div class="mempool-stat">
          <span class="mempool-stat-label">Mempool TX</span>
          <span class="mempool-stat-value" id="mempool-tx">--</span>
        </div>
        <div class="mempool-stat">
          <span class="mempool-stat-label">Usage</span>
          <span class="mempool-stat-value" id="mempool-usage">--</span>
        </div>
        <div class="mempool-stat">
          <span class="mempool-stat-label">Expected Tier</span>
          <span class="mempool-stat-value" id="mempool-tier">--</span>
        </div>
        <div class="mempool-stat" style="margin-left:auto;">
          <span class="mempool-stat-label" id="mempool-freshness"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Live stats ────────────────────────────── -->
  <section style="padding: 0 0 8px;">
    <div class="container">
      <div class="last-updated" id="last-updated"></div>
      <div class="observe-stats fade-up" id="stats-grid" style="animation-delay:.15s;">
        <div class="observe-stat">
          <div class="observe-stat-value" id="stat-total">--</div>
          <div class="observe-stat-label">Total Verdicts</div>
        </div>
        <div class="observe-stat">
          <div class="observe-stat-value green" id="stat-accepted">--</div>
          <div class="observe-stat-label">Accepted</div>
        </div>
        <div class="observe-stat">
          <div class="observe-stat-value red" id="stat-rejected">--</div>
          <div class="observe-stat-label">Rejected</div>
        </div>
        <div class="observe-stat">
          <div class="observe-stat-value" id="stat-rate">--</div>
          <div class="observe-stat-label">Accept Rate</div>
          <div class="observe-stat-sub" id="stat-rate-sub"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Verdict stream + Reason breakdown ─────── -->
  <section style="padding: 16px 0 8px;">
    <div class="container">
      <div class="observe-columns fade-up" style="animation-delay:.2s;">

        <!-- Verdict stream -->
        <div class="verdict-stream">
          <div class="verdict-stream-header">
            Recent Verdicts
            <small id="verdict-count">0 loaded</small>
          </div>
          <div class="verdict-stream-body" id="verdict-list">
            <div style="padding:40px 20px;text-align:center;color:var(--ink-subtle);font-size:14px;">
              Waiting for data...
            </div>
          </div>
        </div>

        <!-- Export bar -->
        <div class="export-bar" id="export-bar" style="display:none;grid-column:1/-1;">
          <span>Export verdict data:</span>
          <a class="export-link" id="export-csv" href="#" target="_blank">CSV</a>
          <a class="export-link" id="export-ndjson" href="#" target="_blank">NDJSON</a>
        </div>

        <!-- Reason breakdown -->
        <div class="reason-panel">
          <div class="reason-panel-header">Rejection Reasons</div>
          <div class="reason-chart" id="reason-chart">
            <div class="reason-empty">No rejection data yet</div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ── Consensus safety ─────────────────────── -->
  <section style="padding: 0 0 8px;">
    <div class="container">
      <div class="safety-section fade-up" style="animation-delay:.22s;">
        <div class="safety-header">
          Consensus Safety
          <small>from latest verdict</small>
        </div>
        <div class="safety-grid">
          <div class="safety-metric">
            <div class="safety-metric-label">Weight utilization <span class="enforce-badge observe" id="badge-weight-mode">observe</span></div>
            <div class="gauge-track">
              <div class="gauge-fill weight" id="gauge-weight" style="width:0%;"></div>
            </div>
            <div class="gauge-label" id="label-weight">n/a</div>
          </div>
          <div class="safety-metric">
            <div class="safety-metric-label">Sigops headroom <span class="enforce-badge observe" id="badge-sigops-mode">observe</span></div>
            <div class="gauge-track">
              <div class="gauge-fill sigops" id="gauge-sigops" style="width:0%;"></div>
            </div>
            <div class="gauge-label" id="label-sigops">n/a</div>
          </div>
          <div class="safety-metric">
            <div class="safety-metric-label">Template age <span class="enforce-badge observe" id="badge-age-mode">observe</span></div>
            <div class="safety-value" id="label-template-age">n/a</div>
          </div>
          <div class="safety-metric">
            <div class="safety-metric-label">Coinbase sigops <span class="enforce-badge observe" id="badge-coinbase-mode">observe</span></div>
            <div class="safety-value" id="label-coinbase-sigops">n/a</div>
          </div>
        </div>
        <div class="safety-warnings-bar" id="safety-warnings-bar">No warnings</div>
      </div>
    </div>
  </section>

  <!-- ── Fee tier distribution ─────────────────── -->
  <section class="section" style="padding-top:24px;">
    <div class="container">
      <div class="section-header fade-up" style="animation-delay:.25s;">
        <span class="section-eyebrow">Fee Tiers</span>
        <h2>Mempool-driven fee tier distribution</h2>
        <p>Templates are evaluated against dynamic fee thresholds based on current mempool conditions.</p>
      </div>
      <div class="tier-grid fade-up" style="animation-delay:.3s;">
        <div class="tier-card" id="tier-low">
          <div class="tier-name">Low</div>
          <div class="tier-count" id="tier-low-count">--</div>
          <div class="tier-threshold" id="tier-low-thresh"></div>
        </div>
        <div class="tier-card" id="tier-mid">
          <div class="tier-name">Mid</div>
          <div class="tier-count" id="tier-mid-count">--</div>
          <div class="tier-threshold" id="tier-mid-thresh"></div>
        </div>
        <div class="tier-card" id="tier-high">
          <div class="tier-name">High</div>
          <div class="tier-count" id="tier-high-count">--</div>
          <div class="tier-threshold" id="tier-high-thresh"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Active policy ─────────────────────────── -->
  <section class="section" style="padding-top:0;">
    <div class="container">
      <details class="policy-toggle code-panel fade-up" style="animation-delay:.35s;">
        <summary>Active Policy Configuration</summary>
        <pre id="policy-json" style="margin:0;padding:20px;font-size:13px;overflow-x:auto;"></pre>
      </details>
    </div>
  </section>

  <!-- ── Architecture diagram ──────────────────── -->
  <section class="section section-alt">
    <div class="container">
      <div class="section-header fade-up">
        <span class="section-eyebrow">Architecture</span>
        <h2>System overview</h2>
        <p>ReserveGrid OS sits between the Bitcoin node and the pool, verifying every block template against operator-defined policy.</p>
      </div>
      <div class="arch-diagram fade-up" style="animation-delay:.1s;">
        <div class="arch-box">
          <div class="arch-box-icon">&#x26D3;</div>
          <div class="arch-box-name">bitcoind</div>
          <div class="arch-box-desc">Bitcoin Core node producing block templates via getblocktemplate</div>
        </div>
        <div class="arch-arrow">&rarr;</div>
        <div class="arch-box">
          <div class="arch-box-icon">&#x1F4E6;</div>
          <div class="arch-box-name">Template Manager</div>
          <div class="arch-box-desc">Packages raw templates into TemplatePropose with metadata</div>
        </div>
        <div class="arch-arrow">&rarr;</div>
        <div class="arch-box" style="border-color:var(--blue);background:rgba(0,104,181,.03);">
          <div class="arch-box-icon">&#x1F6E1;</div>
          <div class="arch-box-name">Pool Verifier</div>
          <div class="arch-box-desc">Evaluates against policy.toml, emits TemplateVerdict with reason_code</div>
        </div>
        <div class="arch-arrow">&rarr;</div>
        <div class="arch-box" style="border-color:var(--green);background:rgba(118,185,0,.03);">
          <div class="arch-box-icon">&#x1F4CA;</div>
          <div class="arch-box-name">Observe Dashboard</div>
          <div class="arch-box-desc">Read-only analytics, verdict stream, and policy display</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Tech stack ────────────────────────────── -->
  <section class="section">
    <div class="container">
      <div class="section-header fade-up">
        <span class="section-eyebrow">Tech Stack</span>
        <h2>Built for correctness and performance</h2>
      </div>
      <div class="grid-4 fade-up" style="animation-delay:.1s;">
        <div class="card">
          <div class="card-icon card-icon-blue">&#x2699;</div>
          <h3>Rust 2024</h3>
          <p>Memory-safe systems language with zero-cost abstractions. No garbage collector, no runtime overhead, no undefined behavior.</p>
        </div>
        <div class="card">
          <div class="card-icon card-icon-green">&#x26A1;</div>
          <h3>tokio</h3>
          <p>Async runtime for concurrent TCP and HTTP handling. Non-blocking I/O across all connections with minimal resource usage.</p>
        </div>
        <div class="card">
          <div class="card-icon card-icon-navy">&#x1F310;</div>
          <h3>Axum</h3>
          <p>Type-safe HTTP framework built on hyper and tower. Compile-time route validation with ergonomic extractors.</p>
        </div>
        <div class="card">
          <div class="card-icon card-icon-blue">&#x20BF;</div>
          <h3>Bitcoin Protocol</h3>
          <p>Native getblocktemplate integration. NDJSON wire protocol for template proposals and verdicts over TCP.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Reason code catalog ───────────────────── -->
  <section class="section section-alt">
    <div class="container">
      <div class="section-header fade-up">
        <span class="section-eyebrow">Reference</span>
        <h2>Verdict reason code catalog</h2>
        <p>Every rejection carries a canonical, machine-readable reason_code. These codes are stable across protocol, verifier, exports, and documentation.</p>
      </div>
      <div class="table-wrap fade-up" style="animation-delay:.1s;">
        <table class="catalog-table">
          <thead>
            <tr>
              <th>reason_code</th>
              <th>Category</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>protocol_version_mismatch</td>
              <td><span class="catalog-category cat-protocol">Protocol</span></td>
              <td>Template protocol version does not match the version required by policy.</td>
            </tr>
            <tr>
              <td>invalid_prev_hash</td>
              <td><span class="catalog-category cat-protocol">Protocol</span></td>
              <td>Previous block hash contains non-hexadecimal characters.</td>
            </tr>
            <tr>
              <td>prev_hash_len_mismatch</td>
              <td><span class="catalog-category cat-protocol">Protocol</span></td>
              <td>Previous block hash length does not match required_prevhash_len.</td>
            </tr>
            <tr>
              <td>coinbase_value_zero_rejected</td>
              <td><span class="catalog-category cat-policy">Policy</span></td>
              <td>Coinbase value is zero and reject_coinbase_zero flag is enabled.</td>
            </tr>
            <tr>
              <td>empty_template_rejected</td>
              <td><span class="catalog-category cat-policy">Policy</span></td>
              <td>Template has zero transactions and reject_empty_templates flag is enabled.</td>
            </tr>
            <tr>
              <td>tx_count_exceeded</td>
              <td><span class="catalog-category cat-policy">Policy</span></td>
              <td>Transaction count exceeds max_tx_count policy limit.</td>
            </tr>
            <tr>
              <td>total_fees_below_minimum</td>
              <td><span class="catalog-category cat-fee">Fee</span></td>
              <td>Total fees in the template fall below min_total_fees threshold.</td>
            </tr>
            <tr>
              <td>avg_fee_below_minimum</td>
              <td><span class="catalog-category cat-fee">Fee</span></td>
              <td>Average fee per transaction is below the tier-specific minimum threshold.</td>
            </tr>
            <tr>
              <td>policy_load_error</td>
              <td><span class="catalog-category cat-system">System</span></td>
              <td>Policy configuration could not be loaded (lock poisoned or unavailable).</td>
            </tr>
            <tr>
              <td>mempool_backend_unavailable</td>
              <td><span class="catalog-category cat-system">System</span></td>
              <td>Mempool data fetch failed; tier selection fell back to configured default.</td>
            </tr>
            <tr>
              <td>internal_error</td>
              <td><span class="catalog-category cat-system">System</span></td>
              <td>Unexpected handler failure during template evaluation.</td>
            </tr>
            <tr>
              <td>weight_ratio_exceeded</td>
              <td><span class="catalog-category cat-safety">Safety</span></td>
              <td>Template weight as a fraction of MAX_BLOCK_WEIGHT (4,000,000 WU) exceeds the configured max_weight_ratio threshold.</td>
            </tr>
            <tr>
              <td>template_stale</td>
              <td><span class="catalog-category cat-safety">Safety</span></td>
              <td>Template age exceeds max_template_age_ms, indicating the template may be based on outdated chain state.</td>
            </tr>
            <tr>
              <td>sigops_budget_warning</td>
              <td><span class="catalog-category cat-safety">Safety</span></td>
              <td>Total sigops in the template exceed the configured warn_sigops_ratio of MAX_BLOCK_SIGOPS (80,000). Observe-only by default.</td>
            </tr>
            <tr>
              <td>coinbase_sigops_abnormal</td>
              <td><span class="catalog-category cat-safety">Safety</span></td>
              <td>Coinbase transaction sigops exceed warn_coinbase_sigops_max, which may indicate an unusual or adversarial coinbase. Observe-only by default.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ── Verdict flow walkthrough ──────────────── -->
  <section class="section">
    <div class="container">
      <div class="section-header fade-up">
        <span class="section-eyebrow">How It Works</span>
        <h2>Template verification flow</h2>
      </div>
      <div class="flow-steps fade-up" style="animation-delay:.1s;">
        <div class="flow-step">
          <span class="flow-step-num">1</span>
          <h3>Template Proposed</h3>
          <p>Bitcoin node produces a block template. Template Manager packages it as a TemplatePropose with block height, fees, and tx count.</p>
        </div>
        <div class="flow-step">
          <span class="flow-step-num">2</span>
          <h3>Policy Evaluated</h3>
          <p>Pool Verifier checks the template against policy.toml rules in sequence: protocol version, prev hash, fees, tx limits, tier thresholds, and consensus safety checks (weight ratio, template staleness, sigops budget).</p>
        </div>
        <div class="flow-step">
          <span class="flow-step-num">3</span>
          <h3>Verdict Issued</h3>
          <p>A TemplateVerdict is returned with accepted/rejected status, canonical reason_code, human-readable detail, and policy context.</p>
        </div>
        <div class="flow-step">
          <span class="flow-step-num">4</span>
          <h3>Logged &amp; Observable</h3>
          <p>Every verdict is written to disk (NDJSON), kept in memory (last 1000), and exposed via HTTP for this dashboard to display.</p>
        </div>
      </div>
    </div>
  </section>

  </div><!-- /dashboard-content -->

  <!-- ── Footer ────────────────────────────────── -->
  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">
          <img src="/assets/brand/veldra-logo.png" alt="Veldra">
          <p>Infrastructure for Bitcoin mining pool operators.</p>
        </div>
        <div>
          <h4>Product</h4>
          <div class="footer-links">
            <a href="/product/">ReserveGrid OS</a>
            <a href="/observe/">Observe Mode</a>
          </div>
        </div>
        <div>
          <h4>Resources</h4>
          <div class="footer-links">
            <a href="/docs/">Documentation</a>
          </div>
        </div>
        <div>
          <h4>Company</h4>
          <div class="footer-links">
            <a href="/about/">About</a>
            <a href="mailto:jarrondeng@veldra.org">Contact</a>
          </div>
        </div>

      </div>
      <div class="footer-bottom">
        <span>&copy; 2026 Veldra, Inc.</span>
        <div class="footer-legal">
          <a href="/privacy/">Privacy</a>
          <a href="/terms/">Terms</a>
          <a href="/disclaimer/">Disclaimer</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- ── Observe Mode JS ──────────────────────── -->
  <script>
  (function () {
    'use strict';

    // ── State ───────────────────────────────────
    var state = {
      apiUrl: '',
      authUrl: '',
      mode: 'connecting',   // 'connecting' | 'live' | 'demo'
      stats: null,
      verdicts: [],
      policy: null,
      lastUpdate: 0,
      failures: 0,
      pollTimer: null,
      authToken: null,
      authUser: null,
      expandedReasons: {},
      mempool: null
    };

    // ── DOM refs — dashboard ────────────────────
    var $apiUrl      = document.getElementById('api-url');
    var $statusDot   = document.getElementById('status-dot');
    var $statusLabel = document.getElementById('status-label');
    var $demoBanner  = document.getElementById('demo-banner');
    var $lastUpdated = document.getElementById('last-updated');
    var $statsGrid   = document.getElementById('stats-grid');
    var $statTotal   = document.getElementById('stat-total');
    var $statAccept  = document.getElementById('stat-accepted');
    var $statReject  = document.getElementById('stat-rejected');
    var $statRate    = document.getElementById('stat-rate');
    var $statRateSub = document.getElementById('stat-rate-sub');
    var $verdictList = document.getElementById('verdict-list');
    var $verdictCnt  = document.getElementById('verdict-count');
    var $reasonChart = document.getElementById('reason-chart');
    var $policyJson  = document.getElementById('policy-json');
    var $tierLow     = document.getElementById('tier-low');
    var $tierMid     = document.getElementById('tier-mid');
    var $tierHigh    = document.getElementById('tier-high');

    // ── DOM refs — auth ─────────────────────────
    var $authGate     = document.getElementById('auth-gate');
    var $dashboard    = document.getElementById('dashboard-content');
    var $loginForm    = document.getElementById('auth-login-form');
    var $registerForm = document.getElementById('auth-register-form');
    var $loginMsg     = document.getElementById('login-msg');
    var $registerMsg  = document.getElementById('register-msg');
    var $userBar      = document.getElementById('user-bar');
    var $userName     = document.getElementById('user-display-name');
    var $userOrg      = document.getElementById('user-display-org');

    // ── Mock data ───────────────────────────────
    var MOCK_STATS = {
      total: 1247,
      accepted: 1198,
      rejected: 49,
      by_reason: {
        'avg_fee_below_minimum': 31,
        'tx_count_exceeded': 9,
        'total_fees_below_minimum': 4,
        'empty_template_rejected': 3,
        'weight_ratio_exceeded': 1,
        'internal_error': 1
      },
      by_tier: { 'low': 387, 'mid': 534, 'high': 326 }
    };

    var MOCK_POLICY = {
      protocol_version: 2,
      required_prevhash_len: 64,
      min_total_fees: 0,
      max_tx_count: 10000,
      low_mempool_tx: 50,
      high_mempool_tx: 500,
      min_avg_fee_lo: 0,
      min_avg_fee_mid: 500,
      min_avg_fee_hi: 2000,
      reject_empty_templates: true,
      reject_coinbase_zero: false,
      unknown_mempool_as_high: true,
      max_weight_ratio: 0.999,
      enforce_weight_ratio: false,
      max_template_age_ms: null,
      enforce_template_age: false,
      warn_sigops_ratio: 0.95,
      warn_coinbase_sigops_max: 400
    };

    function generateMockVerdicts() {
      var reasons = [null, null, null, null, null, null, 'avg_fee_below_minimum', 'tx_count_exceeded', null, null,
                     null, null, 'total_fees_below_minimum', null, null, null, 'empty_template_rejected', null, 'sigops_budget_warning', null];
      var tiers = ['low', 'mid', 'mid', 'high', 'mid', 'low', 'high', 'mid'];
      var out = [];
      var now = Date.now();
      for (var i = 0; i < 20; i++) {
        var rc = reasons[i % reasons.length];
        var accepted = rc === null || rc === 'sigops_budget_warning';
        var weight = accepted ? (2800000 + Math.floor(Math.random() * 1000000)) : (3900000 + Math.floor(Math.random() * 90000));
        var sigops = accepted ? (40000 + Math.floor(Math.random() * 30000)) : (76000 + Math.floor(Math.random() * 4000));
        var warnings = [];
        if (rc === 'sigops_budget_warning') warnings.push('sigops_budget_warning: ' + sigops + ' / 80000');
        out.push({
          log_id: 1247 - i,
          template_id: (1000 + i),
          height: 889012 - i,
          total_fees: accepted ? (1500000 + Math.floor(Math.random() * 2000000)) : (50000 + Math.floor(Math.random() * 100000)),
          tx_count: accepted ? (2000 + Math.floor(Math.random() * 3000)) : (12000 + Math.floor(Math.random() * 2000)),
          accepted: accepted,
          reason_code: (rc === 'sigops_budget_warning') ? null : rc,
          reason_detail: rc ? rc.replace(/_/g, ' ') : null,
          timestamp: Math.floor((now - i * 6000) / 1000),
          min_avg_fee_used: 500,
          fee_tier: tiers[i % tiers.length],
          tier_source: 'measured',
          avg_fee_sats_per_tx: accepted ? (500 + Math.floor(Math.random() * 1000)) : (80 + Math.floor(Math.random() * 100)),
          template_weight: weight,
          total_sigops: sigops,
          coinbase_sigops: null,
          created_at_unix_ms: now - i * 6000,
          safety_warnings: warnings
        });
      }
      return out;
    }

    // ── Auth logic ──────────────────────────────

    function extractAuthUrl() {
      var params = new URLSearchParams(window.location.search);
      if (params.has('auth')) return params.get('auth').replace(/\/+$/, '');
      if (window.location.hostname === 'veldra.org' || window.location.hostname === 'www.veldra.org') {
        return 'https://auth.veldra.org';
      }
      return window.location.protocol + '//' + window.location.hostname + ':3030';
    }

    function extractApiUrl() {
      var params = new URLSearchParams(window.location.search);
      if (params.has('api')) return params.get('api').replace(/\/+$/, '');
      return window.location.protocol + '//' + window.location.hostname + ':8080';
    }

    function showAuthGate() {
      $authGate.classList.remove('hidden');
      $dashboard.classList.add('hidden');
      $userBar.classList.add('hidden');
      stopPolling();
    }

    function showDashboard(user) {
      state.authUser = user;
      $authGate.classList.add('hidden');
      $dashboard.classList.remove('hidden');
      $userBar.classList.remove('hidden');
      $userName.textContent = user.name;
      $userOrg.textContent = user.org;
      // Start the dashboard connection
      state.apiUrl = extractApiUrl();
      $apiUrl.value = state.apiUrl;
      checkMixedContent();
      $apiUrl.addEventListener('change', function () {
        var v = $apiUrl.value.trim();
        if (v && v !== state.apiUrl) {
          state.apiUrl = v;
          checkMixedContent();
          stopPolling();
          state.failures = 0;
          setMode('connecting');
          tryConnect();
        }
      });
      tryConnect();
    }

    function checkSession() {
      var token = localStorage.getItem('rg_auth_token');
      if (!token) {
        showAuthGate();
        return;
      }
      state.authToken = token;
      fetch(state.authUrl + '/auth/session', {
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (data.valid && data.user) {
            showDashboard(data.user);
          } else {
            localStorage.removeItem('rg_auth_token');
            showAuthGate();
          }
        })
        .catch(function () {
          // Auth service unreachable — fall back to showing dashboard in demo mode
          showAuthGate();
        });
    }

    function doLogin() {
      var email = document.getElementById('login-email').value.trim();
      var password = document.getElementById('login-password').value;
      $loginMsg.className = 'auth-msg';
      $loginMsg.style.display = 'none';

      if (!email || !password) {
        showMsg($loginMsg, 'error', 'Email and password are required.');
        return;
      }

      var btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      fetch(state.authUrl + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, password: password })
      })
        .then(function (r) { return r.json().then(function (d) { return { status: r.status, data: d }; }); })
        .then(function (res) {
          btn.disabled = false;
          btn.textContent = 'Sign in';
          if (res.data.ok && res.data.token) {
            localStorage.setItem('rg_auth_token', res.data.token);
            state.authToken = res.data.token;
            showDashboard(res.data.user);
          } else {
            showMsg($loginMsg, 'error', res.data.detail || 'Login failed.');
          }
        })
        .catch(function () {
          btn.disabled = false;
          btn.textContent = 'Sign in';
          showMsg($loginMsg, 'error', 'Cannot reach auth service. Is rg-auth running?');
        });
    }

    function doRegister() {
      var name = document.getElementById('reg-name').value.trim();
      var email = document.getElementById('reg-email').value.trim();
      var org = document.getElementById('reg-org').value.trim();
      var password = document.getElementById('reg-password').value;
      $registerMsg.className = 'auth-msg';
      $registerMsg.style.display = 'none';

      if (!name || !email || !org || !password) {
        showMsg($registerMsg, 'error', 'All fields are required.');
        return;
      }
      if (password.length < 8) {
        showMsg($registerMsg, 'error', 'Password must be at least 8 characters.');
        return;
      }

      var btn = document.getElementById('register-btn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      fetch(state.authUrl + '/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, email: email, org: org, password: password })
      })
        .then(function (r) { return r.json().then(function (d) { return { status: r.status, data: d }; }); })
        .then(function (res) {
          btn.disabled = false;
          btn.textContent = 'Request access';
          if (res.data.ok) {
            showMsg($registerMsg, 'success', 'Check your email to verify your address. You will be notified when approved.');
          } else {
            showMsg($registerMsg, 'error', res.data.detail || 'Registration failed.');
          }
        })
        .catch(function () {
          btn.disabled = false;
          btn.textContent = 'Request access';
          showMsg($registerMsg, 'error', 'Cannot reach auth service. Is rg-auth running?');
        });
    }

    function doLogout() {
      var token = state.authToken;
      localStorage.removeItem('rg_auth_token');
      state.authToken = null;
      state.authUser = null;
      stopPolling();
      showAuthGate();
      if (token) {
        fetch(state.authUrl + '/auth/logout', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        }).catch(function () {});
      }
    }

    function showMsg(el, type, msg) {
      el.className = 'auth-msg ' + type;
      el.textContent = msg;
      el.style.display = 'block';
    }

    // ── Init ────────────────────────────────────
    function init() {
      var params = new URLSearchParams(window.location.search);
      var isLocal = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
      var authRequired = !(params.has('noauth') && isLocal);
      state.authUrl = extractAuthUrl();

      // Wire up auth form toggles
      document.getElementById('show-register').addEventListener('click', function () {
        $loginForm.classList.add('hidden');
        $registerForm.classList.remove('hidden');
        $loginMsg.style.display = 'none';
      });
      document.getElementById('show-login').addEventListener('click', function () {
        $registerForm.classList.add('hidden');
        $loginForm.classList.remove('hidden');
        $registerMsg.style.display = 'none';
      });

      // Wire up auth actions
      document.getElementById('login-btn').addEventListener('click', doLogin);
      document.getElementById('register-btn').addEventListener('click', doRegister);
      document.getElementById('logout-btn').addEventListener('click', doLogout);

      // Allow Enter key to submit forms
      document.getElementById('login-password').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') doLogin();
      });
      document.getElementById('reg-password').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') doRegister();
      });

      // If no ?auth= param, skip auth gate and go straight to dashboard
      if (!authRequired) {
        showDashboardNoAuth();
        return;
      }

      // Check existing session
      checkSession();
    }

    // Show dashboard without auth (no ?auth= param in URL)
    function showDashboardNoAuth() {
      $authGate.classList.add('hidden');
      $dashboard.classList.remove('hidden');
      $userBar.classList.add('hidden');
      state.apiUrl = extractApiUrl();
      $apiUrl.value = state.apiUrl;
      checkMixedContent();
      $apiUrl.addEventListener('change', function () {
        var v = $apiUrl.value.trim();
        if (v && v !== state.apiUrl) {
          state.apiUrl = v;
          checkMixedContent();
          stopPolling();
          state.failures = 0;
          setMode('connecting');
          tryConnect();
        }
      });
      tryConnect();
    }

    // ── Mode management ─────────────────────────
    function setMode(mode) {
      state.mode = mode;
      $statusDot.className = 'status-dot ' + mode;
      if (mode === 'live') {
        $statusLabel.textContent = 'Live';
        $demoBanner.classList.add('hidden');
        $statsGrid.classList.add('stat-live');
      } else if (mode === 'demo') {
        $statusLabel.textContent = 'Demo';
        $demoBanner.classList.remove('hidden');
        $statsGrid.classList.remove('stat-live');
      } else {
        $statusLabel.textContent = 'Connecting...';
        $demoBanner.classList.add('hidden');
        $statsGrid.classList.remove('stat-live');
      }
    }

    // ── Connection ──────────────────────────────
    function tryConnect() {
      fetch(state.apiUrl + '/health', { mode: 'cors' })
        .then(function (r) {
          if (r.ok) {
            setMode('live');
            state.failures = 0;
            pollAll();
            startPolling();
          } else {
            enterDemo();
          }
        })
        .catch(function () {
          enterDemo();
        });
    }

    function enterDemo() {
      setMode('demo');
      state.stats = MOCK_STATS;
      state.verdicts = generateMockVerdicts();
      state.policy = MOCK_POLICY;
      state.lastUpdate = Date.now();
      renderAll();
    }

    // ── Polling ─────────────────────────────────
    function startPolling() {
      stopPolling();
      state.pollTimer = setInterval(function () {
        pollAll();
      }, 3000);
    }

    function stopPolling() {
      if (state.pollTimer) {
        clearInterval(state.pollTimer);
        state.pollTimer = null;
      }
    }

    function pollAll() {
      if (state.mode !== 'live') return;

      Promise.all([
        safeFetch(state.apiUrl + '/stats'),
        safeFetch(state.apiUrl + '/verdicts'),
        safeFetch(state.apiUrl + '/policy'),
        safeFetch(state.apiUrl + '/mempool').catch(function () { return null; })
      ]).then(function (results) {
        if (results[0]) state.stats = results[0];
        if (results[1]) state.verdicts = results[1].slice(0, 100);
        if (results[2]) state.policy = results[2];
        state.mempool = results[3] || null;
        state.lastUpdate = Date.now();
        state.failures = 0;
        renderAll();
      }).catch(function () {
        state.failures++;
        if (state.failures >= 5) {
          stopPolling();
          enterDemo();
        }
      });
    }

    function safeFetch(url) {
      return fetch(url, { mode: 'cors' })
        .then(function (r) {
          if (!r.ok) throw new Error(r.status);
          return r.json();
        });
    }

    // ── Render ──────────────────────────────────
    function renderAll() {
      renderStats();
      renderVerdicts();
      renderReasons();
      renderSafety();
      renderEnforcementBadges();
      renderMempool();
      renderExportLinks();
      renderTiers();
      renderPolicy();
      renderLastUpdated();
    }

    function renderStats() {
      if (!state.stats) return;
      var s = state.stats;
      var total = s.total || 0;
      var accepted = s.accepted || 0;
      var rejected = s.rejected || 0;
      var rate = total > 0 ? ((accepted / total) * 100) : 0;

      $statTotal.textContent = formatNum(total);
      $statAccept.textContent = formatNum(accepted);
      $statReject.textContent = formatNum(rejected);
      $statRate.textContent = rate.toFixed(1) + '%';

      // Color the rate
      if (rate >= 95) $statRate.style.color = 'var(--green)';
      else if (rate >= 80) $statRate.style.color = '#d4880f';
      else $statRate.style.color = '#dc503c';
    }

    function renderVerdicts() {
      if (!state.verdicts || state.verdicts.length === 0) return;
      var vds = state.verdicts.slice(0, 20);
      $verdictCnt.textContent = state.verdicts.length + ' loaded';

      var html = '';
      for (var i = 0; i < vds.length; i++) {
        var v = vds[i];
        var cls = v.accepted ? 'accepted' : 'rejected';
        var badge = v.accepted
          ? '<span class="verdict-badge ok">OK</span>'
          : '<span class="verdict-badge fail">REJ</span>';

        html += '<div class="verdict-row ' + cls + '">';
        html += '<div class="verdict-ts">' + relTime(v.timestamp) + '</div>';
        html += '<div class="verdict-id">#' + v.template_id + '</div>';
        html += '<div class="verdict-height">' + formatNum(v.height) + '</div>';
        html += '<div class="verdict-txcount">' + formatNum(v.tx_count) + ' tx</div>';
        html += badge;

        if (v.reason_code && !v.accepted) {
          html += '<div class="verdict-reason">' + escHtml(v.reason_code) + '</div>';
        }
        if (v.safety_warnings && v.safety_warnings.length > 0) {
          html += '<div class="verdict-reason" style="color:#b45309;">' + escHtml(v.safety_warnings.join('; ')) + '</div>';
        }
        html += '</div>';
      }
      $verdictList.innerHTML = html;
    }

    function renderReasons() {
      if (!state.stats || !state.stats.by_reason) return;
      var reasons = state.stats.by_reason;
      var entries = Object.keys(reasons).map(function (k) {
        return { code: k, count: reasons[k] };
      }).sort(function (a, b) { return b.count - a.count; }).slice(0, 8);

      if (entries.length === 0) {
        $reasonChart.innerHTML = '<div class="reason-empty">No rejections recorded</div>';
        return;
      }

      // Build a map of reason_code to matching verdicts for drill-down
      var byReasonVerdicts = {};
      (state.verdicts || []).forEach(function (v) {
        if (!v.accepted && v.reason_code) {
          if (!byReasonVerdicts[v.reason_code]) byReasonVerdicts[v.reason_code] = [];
          byReasonVerdicts[v.reason_code].push(v);
        }
      });

      var maxCount = entries[0].count;
      var AGG_LIMIT = 10;
      var html = '';
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        var pct = maxCount > 0 ? (e.count / maxCount) * 100 : 0;
        var matching = byReasonVerdicts[e.code] || [];
        var canExpand = matching.length > 0;
        var isExpanded = !!state.expandedReasons[e.code];

        html += '<div class="reason-item' + (canExpand ? ' expandable' : '') + '" data-reason="' + escHtml(e.code) + '">';
        html += '<div class="reason-label">';
        if (canExpand) {
          html += '<span class="reason-chevron' + (isExpanded ? ' open' : '') + '">&#x25B6;</span>';
        }
        html += escHtml(e.code) + '</div>';
        html += '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%"></div></div>';
        html += '<div class="reason-count">' + e.count + '</div>';
        html += '</div>';

        if (isExpanded && canExpand) {
          var slice = matching.slice(0, AGG_LIMIT);
          for (var j = 0; j < slice.length; j++) {
            var v = slice[j];
            var parts = [];
            parts.push(relTime(v.timestamp));
            parts.push('#' + v.template_id);
            parts.push('h:' + formatNum(v.height));
            if (v.reason_detail) parts.push(v.reason_detail);
            html += '<div class="reason-detail-row">' + escHtml(parts.join('  ')) + '</div>';
          }
          if (matching.length > AGG_LIMIT) {
            html += '<div class="reason-more">\u2026 ' + (matching.length - AGG_LIMIT) + ' more</div>';
          }
        }
      }
      $reasonChart.innerHTML = html;

      // Wire up click handlers for expandable rows
      var expandables = $reasonChart.querySelectorAll('.reason-item.expandable');
      for (var k = 0; k < expandables.length; k++) {
        (function (el) {
          el.addEventListener('click', function () {
            var code = el.getAttribute('data-reason');
            state.expandedReasons[code] = !state.expandedReasons[code];
            renderReasons();
          });
        })(expandables[k]);
      }
    }

    function renderSafety() {
      var src = (state.verdicts && state.verdicts.length > 0)
        ? state.verdicts[state.verdicts.length - 1]
        : null;

      var gaugeWeight = document.getElementById('gauge-weight');
      var lblWeight = document.getElementById('label-weight');
      if (src && typeof src.template_weight === 'number') {
        var wpct = (src.template_weight / 4000000 * 100);
        if (gaugeWeight) {
          gaugeWeight.style.width = Math.min(wpct, 100).toFixed(1) + '%';
          gaugeWeight.className = 'gauge-fill weight' + (wpct > 99 ? ' critical' : '');
        }
        if (lblWeight) lblWeight.textContent = Number(src.template_weight).toLocaleString() + ' / 4,000,000 WU (' + wpct.toFixed(1) + '%)';
      } else {
        if (gaugeWeight) gaugeWeight.style.width = '0%';
        if (lblWeight) lblWeight.textContent = 'n/a';
      }

      var gaugeSigops = document.getElementById('gauge-sigops');
      var lblSigops = document.getElementById('label-sigops');
      if (src && typeof src.total_sigops === 'number') {
        var spct = (src.total_sigops / 80000 * 100);
        if (gaugeSigops) {
          gaugeSigops.style.width = Math.min(spct, 100).toFixed(1) + '%';
          gaugeSigops.className = 'gauge-fill sigops' + (spct > 95 ? ' critical' : '');
        }
        if (lblSigops) lblSigops.textContent = Number(src.total_sigops).toLocaleString() + ' / 80,000 (' + spct.toFixed(1) + '%)';
      } else {
        if (gaugeSigops) gaugeSigops.style.width = '0%';
        if (lblSigops) lblSigops.textContent = 'n/a';
      }

      var lblAge = document.getElementById('label-template-age');
      if (src && typeof src.created_at_unix_ms === 'number') {
        var ageMs = Date.now() - src.created_at_unix_ms;
        if (lblAge) {
          lblAge.textContent = (ageMs / 1000).toFixed(1) + 's';
          lblAge.className = 'safety-value' + (ageMs > 30000 ? ' warn' : '');
        }
      } else {
        if (lblAge) { lblAge.textContent = 'n/a'; lblAge.className = 'safety-value'; }
      }

      var lblCb = document.getElementById('label-coinbase-sigops');
      if (src && typeof src.coinbase_sigops === 'number') {
        if (lblCb) {
          lblCb.textContent = String(src.coinbase_sigops);
          lblCb.className = 'safety-value' + (src.coinbase_sigops > 400 ? ' warn' : '');
        }
      } else {
        if (lblCb) { lblCb.textContent = 'n/a'; lblCb.className = 'safety-value'; }
      }

      var warnBar = document.getElementById('safety-warnings-bar');
      if (src && Array.isArray(src.safety_warnings) && src.safety_warnings.length > 0) {
        if (warnBar) {
          warnBar.textContent = src.safety_warnings.length + ' warning(s): ' + src.safety_warnings.join(', ');
          warnBar.className = 'safety-warnings-bar active';
        }
      } else {
        if (warnBar) { warnBar.textContent = 'No warnings'; warnBar.className = 'safety-warnings-bar'; }
      }
    }

    function renderEnforcementBadges() {
      var p = state.policy;
      function setBadge(id, enforced) {
        var el = document.getElementById(id);
        if (!el) return;
        if (enforced) {
          el.textContent = 'enforced';
          el.className = 'enforce-badge enforced';
        } else {
          el.textContent = 'observe';
          el.className = 'enforce-badge observe';
        }
      }
      if (p) {
        setBadge('badge-weight-mode', p.enforce_weight_ratio);
        setBadge('badge-age-mode', p.enforce_template_age);
        // Sigops and coinbase are always observe-only in 0.2.2
        setBadge('badge-sigops-mode', false);
        setBadge('badge-coinbase-mode', false);
      }
    }

    function renderMempool() {
      var bar = document.getElementById('mempool-bar');
      var mp = state.mempool;
      if (!mp || mp.error || typeof mp.tx_count !== 'number') {
        if (bar) bar.style.display = 'none';
        return;
      }
      if (bar) bar.style.display = '';

      var txEl = document.getElementById('mempool-tx');
      var usageEl = document.getElementById('mempool-usage');
      var tierEl = document.getElementById('mempool-tier');
      var freshEl = document.getElementById('mempool-freshness');

      if (txEl) txEl.textContent = formatNum(mp.tx_count);

      if (usageEl) {
        if (typeof mp.usage === 'number' && typeof mp.max === 'number' && mp.max > 0) {
          var pct = (mp.usage * 100.0 / mp.max);
          usageEl.textContent = pct.toFixed(1) + '%';
        } else if (typeof mp.usage === 'number') {
          usageEl.textContent = formatNum(mp.usage) + ' bytes';
        } else if (typeof mp.bytes === 'number') {
          usageEl.textContent = formatNum(mp.bytes) + ' bytes';
        } else {
          usageEl.textContent = 'n/a';
        }
      }

      if (tierEl && state.policy) {
        var lo = state.policy.low_mempool_tx;
        var hi = state.policy.high_mempool_tx;
        if (typeof lo === 'number' && typeof hi === 'number') {
          if (mp.tx_count < lo) tierEl.textContent = 'low';
          else if (mp.tx_count < hi) tierEl.textContent = 'mid';
          else tierEl.textContent = 'high';
        } else {
          tierEl.textContent = 'n/a';
        }
      }

      if (freshEl && typeof mp.timestamp === 'number') {
        var ageSec = Math.floor(Date.now() / 1000) - mp.timestamp;
        if (ageSec > 30) freshEl.textContent = 'stale (' + ageSec + 's ago)';
        else freshEl.textContent = 'updated ' + ageSec + 's ago';
      }
    }

    function renderExportLinks() {
      var bar = document.getElementById('export-bar');
      if (state.mode !== 'live' || !state.apiUrl) {
        if (bar) bar.style.display = 'none';
        return;
      }
      if (bar) bar.style.display = '';
      var csvLink = document.getElementById('export-csv');
      var ndjsonLink = document.getElementById('export-ndjson');
      if (csvLink) csvLink.href = state.apiUrl + '/verdicts.csv';
      if (ndjsonLink) ndjsonLink.href = state.apiUrl + '/verdicts/log';
    }

    function checkMixedContent() {
      var warn = document.getElementById('mixed-content-warn');
      if (!warn) return;
      var pageHttps = window.location.protocol === 'https:';
      var apiHttp = state.apiUrl && state.apiUrl.indexOf('http://') === 0;
      if (pageHttps && apiHttp) {
        warn.style.display = 'block';
      } else {
        warn.style.display = 'none';
      }
    }

    function renderTiers() {
      if (!state.stats || !state.stats.by_tier) return;
      var tiers = state.stats.by_tier;
      var low = tiers['low'] || 0;
      var mid = tiers['mid'] || 0;
      var high = tiers['high'] || 0;
      var maxTier = Math.max(low, mid, high);

      document.getElementById('tier-low-count').textContent = formatNum(low);
      document.getElementById('tier-mid-count').textContent = formatNum(mid);
      document.getElementById('tier-high-count').textContent = formatNum(high);

      // Highlight the most active tier
      $tierLow.classList.toggle('active', low === maxTier && low > 0);
      $tierMid.classList.toggle('active', mid === maxTier && mid > 0);
      $tierHigh.classList.toggle('active', high === maxTier && high > 0);

      // Show thresholds from policy if available
      if (state.policy) {
        document.getElementById('tier-low-thresh').textContent =
          'min_avg_fee: ' + (state.policy.min_avg_fee_lo || 0) + ' sat/tx';
        document.getElementById('tier-mid-thresh').textContent =
          'min_avg_fee: ' + (state.policy.min_avg_fee_mid || 0) + ' sat/tx';
        document.getElementById('tier-high-thresh').textContent =
          'min_avg_fee: ' + (state.policy.min_avg_fee_hi || 0) + ' sat/tx';
      }
    }

    function renderPolicy() {
      if (!state.policy) return;
      $policyJson.textContent = JSON.stringify(state.policy, null, 2);
    }

    function renderLastUpdated() {
      if (state.lastUpdate === 0) return;
      var ago = Math.floor((Date.now() - state.lastUpdate) / 1000);
      var stale = ago > 30;
      $lastUpdated.textContent = 'Last updated: ' + (ago < 2 ? 'just now' : ago + 's ago');
      $statsGrid.classList.toggle('stale', stale);
      // Extend stale overlay to the entire dashboard container
      $dashboard.classList.toggle('stale', stale);
    }

    // ── Helpers ─────────────────────────────────
    function formatNum(n) {
      if (n === undefined || n === null) return '--';
      return Number(n).toLocaleString();
    }

    function relTime(unixSec) {
      var secs = Math.floor(Date.now() / 1000) - unixSec;
      if (secs < 0) secs = 0;
      if (secs < 60) return secs + 's';
      if (secs < 3600) return Math.floor(secs / 60) + 'm';
      if (secs < 86400) return Math.floor(secs / 3600) + 'h';
      return Math.floor(secs / 86400) + 'd';
    }

    function escHtml(s) {
      if (!s) return '';
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ── Update last-updated timestamp periodically
    setInterval(function () {
      if (state.lastUpdate > 0) renderLastUpdated();
    }, 1000);

    // ── Boot ────────────────────────────────────
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script>

</body>
</html>
